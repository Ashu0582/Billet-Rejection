Sub FormatSheet()
    Dim wsRaw As Worksheet
    Dim wsFormatted As Worksheet
    Dim lastRow As Long
    Dim i As Long, j As Long
    Dim startRow As Long
    Dim endRow As Long
    
    ' Set worksheets
    Set wsRaw = ThisWorkbook.Sheets("Raw")
    Set wsFormatted = ThisWorkbook.Sheets("Formatted")
    
    ' Clear Formatted sheet
    wsFormatted.Cells.Clear
    
    ' Copy data from Raw to Formatted
    wsRaw.Cells.Copy Destination:=wsFormatted.Cells
    
    ' Delete column D from Formatted sheet
    wsFormatted.Columns("D").Delete
    
    ' Get the last row
    lastRow = wsFormatted.Cells(wsFormatted.Rows.Count, "A").End(xlUp).Row
    
    ' Color rows based on values in column J (originally K before deletion)
    For i = 2 To lastRow
        Select Case wsFormatted.Cells(i, "J").Value
            Case "Red"
                wsFormatted.Range(wsFormatted.Cells(i, "D"), wsFormatted.Cells(i, "K")).Interior.Color = RGB(255, 0, 0)
            Case "Amber"
                wsFormatted.Range(wsFormatted.Cells(i, "D"), wsFormatted.Cells(i, "K")).Interior.Color = RGB(255, 191, 0)
            Case "Green"
                wsFormatted.Range(wsFormatted.Cells(i, "D"), wsFormatted.Cells(i, "K")).Interior.Color = RGB(0, 255, 0)
        End Select
    Next i
    
    ' Sort by Incident number (Column A) and Color (Column J)
    With wsFormatted.Sort
        .SortFields.Clear
        .SortFields.Add Key:=wsFormatted.Range("A2:A" & lastRow), Order:=xlAscending
        .SortFields.Add Key:=wsFormatted.Range("J2:J" & lastRow), Order:=xlAscending, CustomOrder:="Red,Amber,Green"
        .SetRange wsFormatted.Range("A1:K" & lastRow)
        .Header = xlYes
        .Apply
    End With
    
    ' Merge and center align columns A, B, and C for same incidents
    i = 2
    Do While i <= lastRow
        startRow = i
        
        ' Find the last row of the same incident
        Do While i <= lastRow And wsFormatted.Cells(i, "A").Value = wsFormatted.Cells(startRow, "A").Value
            i = i + 1
        Loop
        
        endRow = i - 1
        
        If endRow > startRow Then
            ' Ensure upper-left value is kept and others are cleared before merging
            For j = startRow + 1 To endRow
                wsFormatted.Cells(j, "A").ClearContents
                wsFormatted.Cells(j, "B").ClearContents
                wsFormatted.Cells(j, "C").ClearContents
            Next j
            
            ' Merge and center align
            With wsFormatted
                .Range(.Cells(startRow, "A"), .Cells(endRow, "A")).Merge
                .Range(.Cells(startRow, "B"), .Cells(endRow, "B")).Merge
                .Range(.Cells(startRow, "C"), .Cells(endRow, "C")).Merge
                .Cells(startRow, "A").HorizontalAlignment = xlCenter
                .Cells(startRow, "B").HorizontalAlignment = xlCenter
                .Cells(startRow, "C").HorizontalAlignment = xlCenter
            End With
        End If
    Loop
    
    ' Sort by Incident Date (Column B)
    With wsFormatted.Sort
        .SortFields.Clear
        .SortFields.Add Key:=wsFormatted.Range("B2:B" & lastRow), Order:=xlAscending
        .SetRange wsFormatted.Range("A1:K" & lastRow)
        .Header = xlYes
        .Apply
    End With
    
End Sub
